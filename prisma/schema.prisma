generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  username            String    @unique
  email               String    @unique
  password            String?
  role                String
  failedLoginAttempts Int       @default(0)
  lockoutUntil        DateTime?
  
  // OAuth fields
  provider            String?   // "google", "linkedin", or null for email/password
  providerId          String?   // OAuth provider user ID
  providerEmail       String?   // Email from OAuth provider
  
  // Profile fields
  firstName           String?
  lastName            String?
  avatar              String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([provider, providerId])

  courses            Course[]               @relation("InstructorCourses")
  enrollments        Enrollment[]
  submissions        Submission[]
  payments           Payment[]
  securityLogs       SecurityLog[]
  materials          Material[]
  videos             Video[]
  liveStreams        LiveStream[]
  streamQuestions    StreamQuestion[]
  streamPolls        StreamPoll[]
  pollResponses      PollResponse[]
  courseModules      CourseModule[]
  quizAttempts       QuizAttempt[]
  quizGraded         QuizAttempt[]          @relation("QuizGrader")
  createdQuizzes     Quiz[]
  createdAssignments Assignment[]
  progress           Progress[]
  achievements       Achievement[]
  certificates       Certificate[]
  recommendations    CourseRecommendation[]
  createdWhiteboards Whiteboard[]            @relation("WhiteboardCreator")
  whiteboardActions  WhiteboardAction[]      @relation("WhiteboardActionUser")
  interactions       UserInteraction[]
  createdEvents      CalendarEvent[]
  eventAttendees     EventAttendee[]
  eventReminders     EventReminder[]
  Poll               Poll[]
  Notification       Notification[]
  AuditLog           AuditLog[]
  Interaction        Interaction[]
  sentMessages       Message[]                    @relation("MessageSender")
  receivedMessages   Message[]                    @relation("MessageReceiver")
  conversations      ConversationParticipant[]
  createdConversations Conversation[]
  messageReactions   MessageReaction[]
  messageReads       MessageRead[]
  announcements      Announcement[]
  availabilities     TeacherAvailability[]
  bookingsAsStudent  Booking[]             @relation("BookingStudent")
  bookingsAsTeacher  Booking[]             @relation("BookingTeacher")
  attendances        Attendance[]
  lessonSlots        LessonSlot[]          @relation("LessonSlotTeacher")
  quickLessons       QuickLesson[]         @relation("QuickLessonTeacher")
  lessonResourcesCreated LessonResource[]  @relation("LessonResourceSharer")
  videoConferencesHosted VideoConference[] @relation("VideoConferenceHost")
}

model SecurityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  price       Float
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   @db.ObjectId

  instructorId String @db.ObjectId
  instructor   User   @relation("InstructorCourses", fields: [instructorId], references: [id])

  enrollments     Enrollment[]
  lessons         Lesson[]
  quizzes         Quiz[]
  polls           Poll[]
  assignments     Assignment[]
  payments        Payment[]
  materials       Material[]
  videos          Video[]
  liveStreams     LiveStream[]
  modules         CourseModule[]
  progress        Progress[]
  achievements    Achievement[]
  certificates    Certificate[]
  recommendations CourseRecommendation[]
  interactions    UserInteraction[]
  events          CalendarEvent[]
  Interaction     Interaction[]
  announcements   Announcement[]
  whiteboards     Whiteboard[]
}

model Enrollment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])

  paymentId String?  @unique @db.ObjectId
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())

  @@unique([courseId, studentId])
  @@index([courseId])
  @@index([studentId])
}

model Payment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])

  enrollment Enrollment?

  amount        Float
  currency      String   @default("USD")
  status        String
  provider      String
  transactionId String?
  createdAt     DateTime @default(now())
}

model Material {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId   String   @db.ObjectId
  course     Course   @relation(fields: [courseId], references: [id])
  type       String
  key        String
  filename   String
  size       Int
  mimeType   String
  url        String
  uploadedBy String   @db.ObjectId
  uploader   User     @relation(fields: [uploadedBy], references: [id])
  meta       Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Lesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id])
  title       String
  content     Json?
  order       Int
  scheduledAt DateTime?
  teacherId   String?  @db.ObjectId
  duration    Int?     // Duration in minutes
  joinLink    String?
  meetingId   String?
  status      String   @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quizzes     Quiz[]
}

model Quiz {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  lessonId     String?       @db.ObjectId
  title        String
  description  String?
  instructions String?
  timeLimit    Int?
  maxAttempts  Int?
  passingScore Float?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  dueDate      DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  events      CalendarEvent[]
  Lesson      Lesson?         @relation(fields: [lessonId], references: [id])
  Interaction Interaction[]
}

model QuizQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  quizId        String   @db.ObjectId
  quiz          Quiz     @relation(fields: [quizId], references: [id])
  question      String
  type          String
  options       Json?
  correctAnswer Json?
  points        Int      @default(1)
  order         Int
  explanation   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuizAttempt {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  quizId      String    @db.ObjectId
  quiz        Quiz      @relation(fields: [quizId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  score       Float?
  maxScore    Float
  percentage  Float?
  isPassed    Boolean   @default(false)
  timeSpent   Int?
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  gradedAt    DateTime?
  gradedBy    String?   @db.ObjectId
  grader      User?     @relation("QuizGrader", fields: [gradedBy], references: [id])
  answers     Json?
  feedback    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([quizId, studentId, startedAt])
}

model Assignment {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  title        String
  description  String?
  instructions String?
  type         String
  maxScore     Float?
  dueDate      DateTime?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  submissions Submission[]
  events      CalendarEvent[]
}

model Submission {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String     @db.ObjectId
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  studentId    String     @db.ObjectId
  student      User       @relation(fields: [studentId], references: [id])
  content      String?
  attachments  Json?
  submittedAt  DateTime   @default(now())
  gradedAt     DateTime?
  grade        Float?
  feedback     String?
}

model Poll {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String       @db.ObjectId
  title        String
  description  String?
  moduleId     String?      @db.ObjectId
  course       Course       @relation(fields: [courseId], references: [id])
  liveStreamId String?      @db.ObjectId
  liveStream   LiveStream?  @relation(fields: [liveStreamId], references: [id])
  createdBy    String       @db.ObjectId
  creator      User         @relation(fields: [createdBy], references: [id])
  question     String
  options      PollOption[]
  isActive     Boolean      @default(true)
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  responses PollResponse[]
}

model PollOption {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  pollId String @db.ObjectId
  poll   Poll   @relation(fields: [pollId], references: [id])
  text   String
  order  Int
  votes  Int    @default(0)
}

model Video {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String    @db.ObjectId
  course       Course    @relation(fields: [courseId], references: [id])
  streamId     String    @unique
  title        String
  description  String?
  type         String    @default("on-demand")
  status       String    @default("pending")
  playbackUrl  String?
  thumbnailUrl String?
  duration     Int?
  size         Int?
  uploadedBy   String    @db.ObjectId
  uploader     User      @relation(fields: [uploadedBy], references: [id])
  scheduledAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model LiveStream {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  streamId    String    @unique
  title       String
  description String?
  status      String    @default("ready")
  playbackUrl String?
  rtmpUrl     String?
  streamKey   String?
  isActive    Boolean   @default(false)
  startedAt   DateTime?
  endedAt     DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  questions StreamQuestion[]
  polls     StreamPoll[]
  Poll      Poll[]
  whiteboards Whiteboard[]
}

model StreamQuestion {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId   String
  stream     LiveStream @relation(fields: [streamId], references: [streamId])
  studentId  String     @db.ObjectId
  student    User       @relation(fields: [studentId], references: [id])
  question   String
  timestamp  Int
  isAnswered Boolean    @default(false)
  answeredBy String?    @db.ObjectId
  answer     String?
  answeredAt DateTime?
  createdAt  DateTime   @default(now())
}

model StreamPoll {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId     String
  stream       LiveStream @relation(fields: [streamId], references: [streamId])
  instructorId String     @db.ObjectId
  instructor   User       @relation(fields: [instructorId], references: [id])
  question     String
  options      String[]
  isActive     Boolean    @default(true)
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  responses PollResponse[]
}

model PollResponse {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  pollId    String     @db.ObjectId
  poll      StreamPoll @relation(fields: [pollId], references: [id])
  studentId String     @db.ObjectId
  student   User       @relation(fields: [studentId], references: [id])
  option    String
  createdAt DateTime   @default(now())
  Poll      Poll       @relation(fields: [pollId], references: [id])

  @@unique([pollId, studentId])
}

model Notification {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  toUserId  String    @db.ObjectId
  toUser    User      @relation(fields: [toUserId], references: [id])
  title     String
  message   String
  type      String
  metadata  Json?
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?
}

model CourseModule {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  content     Json?
  description String?
  order       Int
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quizzes     Quiz[]
  assignments Assignment[]
  progress    Progress[]
  Interaction Interaction[]
}

model Progress {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  studentId    String        @db.ObjectId
  student      User          @relation(fields: [studentId], references: [id])
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  type         String
  itemId       String        @db.ObjectId
  status       String
  progress     Float         @default(0)
  score        Float?
  timeSpent    Int?
  lastAccessed DateTime      @default(now())
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([studentId, courseId, type, itemId])
}

model Achievement {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  student   User     @relation(fields: [studentId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  badgeName String
  badgeIcon String?
  earnedAt  DateTime @default(now())
  metadata  Json?

  @@unique([studentId, courseId, badgeName])
}

model Certificate {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  description String?
  template    String?
  issuedAt    DateTime  @default(now())
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([studentId, courseId])
}

model CourseRecommendation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String   @db.ObjectId
  course    Course   @relation(fields: [courseId], references: [id])
  score     Float
  reason    String
  algorithm String
  metadata  Json?
  isViewed  Boolean  @default(false)
  isClicked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([userId, score])
}

model UserInteraction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  type      String
  value     Float?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, type])
  @@index([courseId, type])
}

model CalendarEvent {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  type        String
  startTime   DateTime
  endTime     DateTime?
  isAllDay    Boolean   @default(false)
  location    String?
  courseId    String?   @db.ObjectId
  course      Course?   @relation(fields: [courseId], references: [id])
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])

  assignmentId String?     @db.ObjectId
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  quizId       String?     @db.ObjectId
  quiz         Quiz?       @relation(fields: [quizId], references: [id])

  isRecurring    Boolean @default(false)
  recurrenceRule String?

  reminderMinutes Int[] @default([15])

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendees EventAttendee[]
  reminders EventReminder[]

  @@index([courseId, startTime])
  @@index([createdBy, startTime])
}

model EventAttendee {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String        @db.ObjectId
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String        @db.ObjectId
  user      User          @relation(fields: [userId], references: [id])
  status    String        @default("invited")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([eventId, userId])
}

model EventReminder {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId    String        @db.ObjectId
  event      CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId     String        @db.ObjectId
  user       User          @relation(fields: [userId], references: [id])
  reminderAt DateTime
  type       String        @default("email")
  isSent     Boolean       @default(false)
  createdAt  DateTime      @default(now())

  @@index([reminderAt, isSent])
}

model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?  @db.ObjectId
  metadata  Json?
  createdAt DateTime @default(now())
}

model Interaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  courseId  String?  @db.ObjectId
  moduleId  String?  @db.ObjectId
  quizId    String?  @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  user   User          @relation(fields: [userId], references: [id])
  course Course?       @relation(fields: [courseId], references: [id])
  module CourseModule? @relation(fields: [moduleId], references: [id])
  quiz   Quiz?         @relation(fields: [quizId], references: [id])
}

model Conversation {
  id          String                  @id @default(auto()) @map("_id") @db.ObjectId
  type        String                  @default("direct") // "direct" or "group"
  name        String?                 // For group conversations
  description String?
  createdBy   String                  @db.ObjectId
  creator     User                    @relation(fields: [createdBy], references: [id])
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@index([createdBy])
  @@index([type])
}

model ConversationParticipant {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  role           String       @default("member") // "admin", "member"
  joinedAt       DateTime   @default(now())
  lastReadAt     DateTime?
  isMuted        Boolean    @default(false)
  leftAt         DateTime?

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String       @db.ObjectId
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
  receiverId     String?      @db.ObjectId
  receiver       User?        @relation("MessageReceiver", fields: [receiverId], references: [id])
  content        String
  type           String       @default("text") // "text", "image", "file", "system"
  attachments    Json?        // Array of file attachments
  isRead         Boolean      @default(false)
  readAt         DateTime?
  isEdited       Boolean      @default(false)
  editedAt       DateTime?
  isDeleted      Boolean      @default(false)
  deletedAt      DateTime?
  replyToId      String?      @db.ObjectId
  replyTo        Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[]    @relation("MessageReplies")
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  reactions MessageReaction[]
  reads     MessageRead[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([content]) // For search
}

model MessageReaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // e.g., "üëç", "‚ù§Ô∏è", "üòÇ"
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model MessageRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Announcement {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  message     String
  type        String    @default("global") // "global", "course", "user"
  scope       String    @default("global") // "global", "course", "user"
  courseId    String?   @db.ObjectId
  course      Course?   @relation(fields: [courseId], references: [id])
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  targetUserId String?  @db.ObjectId
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([scope, courseId])
  @@index([createdBy])
  @@index([isActive, expiresAt])
}

model TeacherAvailability {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  teacherId   String    @db.ObjectId
  teacher     User      @relation(fields: [teacherId], references: [id])
  startTime   DateTime
  endTime     DateTime
  isRecurring Boolean   @default(false)
  recurrenceRule String?
  subject     String?
  duration    Int?      // Duration in minutes
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  slots       LessonSlot[]
  @@index([teacherId, startTime])
}

model LessonSlot {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  availabilityId String? @db.ObjectId
  availability TeacherAvailability? @relation(fields: [availabilityId], references: [id])
  teacherId    String    @db.ObjectId
  teacher      User      @relation("LessonSlotTeacher", fields: [teacherId], references: [id])
  startTime    DateTime
  endTime      DateTime
  subject      String?
  duration     Int       // Duration in minutes
  isBooked     Boolean   @default(false)
  isAvailable  Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  booking     Booking?
  @@unique([availabilityId, startTime])
  @@index([teacherId, startTime])
  @@index([isBooked, isAvailable])
}

model Booking {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  slotId      String    @unique @db.ObjectId
  slot        LessonSlot @relation(fields: [slotId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation("BookingStudent", fields: [studentId], references: [id])
  teacherId   String    @db.ObjectId
  teacher     User      @relation("BookingTeacher", fields: [teacherId], references: [id])
  status      String    @default("confirmed") // "confirmed", "cancelled", "completed"
  subject     String?
  notes       String?
  joinLink    String?
  meetingId   String?
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attendance  Attendance?
  @@index([studentId, createdAt])
  @@index([teacherId, createdAt])
  @@index([status])
}

model QuickLesson {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  teacherId   String    @db.ObjectId
  teacher     User      @relation("QuickLessonTeacher", fields: [teacherId], references: [id])
  scheduledAt DateTime
  subject     String?
  duration    Int?      // Duration in minutes
  joinLink    String?
  meetingId   String?
  status      String    @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attendance  Attendance[]
  resources   LessonResource[]
  @@index([teacherId, scheduledAt])
  @@index([status])
}

model Attendance {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonId    String?   @db.ObjectId
  lesson      QuickLesson? @relation(fields: [lessonId], references: [id])
  bookingId   String?   @unique @db.ObjectId
  booking     Booking?  @relation(fields: [bookingId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  status      String    // "present", "absent", "late"
  joinedAt    DateTime?
  leftAt      DateTime?
  duration    Int?      // Duration in seconds
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([lessonId, studentId])
  @@index([studentId])
  @@index([status])
}

model LessonResource {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonId    String    @db.ObjectId
  lesson      QuickLesson @relation(fields: [lessonId], references: [id])
  title       String
  type        String    // "file", "link", "document"
  url         String?
  fileUrl     String?
  filename    String?
  size        Int?
  mimeType    String?
  sharedBy    String    @db.ObjectId
  sharer      User      @relation("LessonResourceSharer", fields: [sharedBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([lessonId, createdAt])
}

model VideoConference {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  conferenceId String   @unique
  title       String
  hostId      String    @db.ObjectId
  host        User      @relation("VideoConferenceHost", fields: [hostId], references: [id])
  joinLink    String
  status      String    @default("scheduled") // "scheduled", "active", "ended"
  startedAt   DateTime?
  endedAt     DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  rooms       BreakoutRoom[]
  @@index([hostId, createdAt])
}

model BreakoutRoom {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  conferenceDbId String          @db.ObjectId
  conference    VideoConference @relation(fields: [conferenceDbId], references: [id])
  name          String
  joinLink      String?
  status        String          @default("open") // "open", "closed"
  participants  String[]        // Array of user IDs
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([conferenceDbId, status])
}

model Whiteboard {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String?            @db.ObjectId
  course      Course?            @relation(fields: [courseId], references: [id])
  liveStreamId String?           @db.ObjectId
  liveStream  LiveStream?        @relation(fields: [liveStreamId], references: [id])
  title       String
  description String?
  createdBy   String             @db.ObjectId
  creator     User               @relation("WhiteboardCreator", fields: [createdBy], references: [id])
  isActive    Boolean            @default(true)
  isPublic    Boolean            @default(false)
  backgroundColor String          @default("#FFFFFF")
  width       Int                @default(1920)
  height      Int                @default(1080)
  actions     WhiteboardAction[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([courseId, createdAt])
  @@index([liveStreamId, createdAt])
}

model WhiteboardAction {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  whiteboardId String    @db.ObjectId
  whiteboard  Whiteboard @relation(fields: [whiteboardId], references: [id], onDelete: Cascade)
  userId      String     @db.ObjectId
  user        User       @relation("WhiteboardActionUser", fields: [userId], references: [id])
  actionType  String     // "draw", "erase", "clear", "undo", "redo", "add_text", "add_shape"
  data        Json       // Contains action-specific data (coordinates, color, tool, etc.)
  timestamp   DateTime   @default(now())
  createdAt   DateTime   @default(now())

  @@index([whiteboardId, timestamp])
  @@index([userId, timestamp])
}
