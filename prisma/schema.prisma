generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  username            String    @unique
  email               String    @unique
  password            String?
  role                String
  failedLoginAttempts Int       @default(0)
  lockoutUntil        DateTime?
  
  // OAuth fields
  provider            String?   // "google", "linkedin", or null for email/password
  providerId          String?   // OAuth provider user ID
  providerEmail       String?   // Email from OAuth provider
  
  // Profile fields
  firstName           String?
  lastName            String?
  avatar              String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([provider, providerId])

  courses            Course[]               @relation("InstructorCourses")
  enrollments        Enrollment[]
  submissions        Submission[]
  payments           Payment[]
  securityLogs       SecurityLog[]
  materials          Material[]
  videos             Video[]
  liveStreams        LiveStream[]
  streamQuestions    StreamQuestion[]
  streamPolls        StreamPoll[]
  pollResponses      PollResponse[]
  courseModules      CourseModule[]
  quizAttempts       QuizAttempt[]
  quizGraded         QuizAttempt[]          @relation("QuizGrader")
  createdQuizzes     Quiz[]
  createdAssignments Assignment[]
  progress           Progress[]
  achievements       Achievement[]
  certificates       Certificate[]
  recommendations    CourseRecommendation[]
  createdWhiteboards Whiteboard[]            @relation("WhiteboardCreator")
  whiteboardActions  WhiteboardAction[]      @relation("WhiteboardActionUser")
  interactions       UserInteraction[]
  createdEvents      CalendarEvent[]
  eventAttendees     EventAttendee[]
  eventReminders     EventReminder[]
  Poll               Poll[]
  notifications      Notification[]
  AuditLog           AuditLog[]
  Interaction        Interaction[]
  sentMessages       Message[]                    @relation("MessageSender")
  receivedMessages   Message[]                    @relation("MessageReceiver")
  conversations      ConversationParticipant[]
  createdConversations Conversation[]
  messageReactions   MessageReaction[]
  messageReads       MessageRead[]
  announcements      Announcement[]
  availabilities     TeacherAvailability[]
  bookingsAsStudent  Booking[]             @relation("BookingStudent")
  bookingsAsTeacher  Booking[]             @relation("BookingTeacher")
  attendances        Attendance[]
  lessonSlots        LessonSlot[]          @relation("LessonSlotTeacher")
  quickLessons       QuickLesson[]         @relation("QuickLessonTeacher")
  lessonResourcesCreated LessonResource[]  @relation("LessonResourceSharer")
  videoConferencesHosted VideoConference[] @relation("VideoConferenceHost")
  settings                UserSettings?
  apiKeys                 ApiKey[]         @relation("ApiKeyUser")
  activityLogs            ActivityLog[]    @relation("ActivityLogUser")
  contentVersions         ContentVersion[] @relation("ContentVersionCreator")
  contentFlagsReported    ContentFlag[]     @relation("ContentFlagReporter")
  contentFlagsReviewed    ContentFlag[]    @relation("ContentFlagReviewer")
  createdGroups           StudyGroup[]      @relation("GroupCreator")
  waitlistEntries         WaitlistEntry[]
  videoAnalytics          VideoAnalytics[]
  groupMembers            GroupMember[]
  sharedWorkspaces         SharedWorkspace[]
  loginStreaks            LoginStreak[]
  videoNotes              VideoNote[]
  videoBookmarks          VideoBookmark[]
  earnedBadges            EarnedBadge[]
  leaderboardEntries      LeaderboardEntry[]
  reviews                 CourseReview[]
  reviewHelpful           ReviewHelpful[]
  forumPosts              ForumPost[]
  forumReplies            ForumReply[]
  forumUpvotes            ForumUpvote[]
  userPoints              UserPoints?       @relation("UserPointsUser")
  userLevels              UserLevel[]       @relation("UserLevelUser")
}

model SecurityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  price       Float
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   @db.ObjectId

  instructorId String @db.ObjectId
  instructor   User   @relation("InstructorCourses", fields: [instructorId], references: [id])

  enrollments     Enrollment[]
  lessons         Lesson[]
  quizzes         Quiz[]
  polls           Poll[]
  assignments     Assignment[]
  payments        Payment[]
  materials       Material[]
  videos          Video[]
  liveStreams     LiveStream[]
  modules         CourseModule[]
  progress        Progress[]
  achievements    Achievement[]
  certificates    Certificate[]
  recommendations CourseRecommendation[]
  interactions    UserInteraction[]
  events          CalendarEvent[]
  Interaction     Interaction[]
  announcements   Announcement[]
  whiteboards     Whiteboard[]
  reviews         CourseReview[]
  forumPosts      ForumPost[]
  studyGroups     StudyGroup[]
  sharedWorkspaces SharedWorkspace[]
  waitlistEntries WaitlistEntry[]
  leaderboardEntries LeaderboardEntry[]
}

model Enrollment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])

  paymentId String?  @unique @db.ObjectId
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())

  @@unique([courseId, studentId])
  @@index([courseId])
  @@index([studentId])
}

model Payment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])

  enrollment Enrollment?

  amount        Float
  currency      String   @default("USD")
  status        String
  provider      String
  transactionId String?
  createdAt     DateTime @default(now())
}

model Material {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId   String   @db.ObjectId
  course     Course   @relation(fields: [courseId], references: [id])
  type       String
  key        String
  filename   String
  size       Int
  mimeType   String
  url        String
  uploadedBy String   @db.ObjectId
  uploader   User     @relation(fields: [uploadedBy], references: [id])
  meta       Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Lesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id])
  title       String
  content     Json?
  order       Int
  scheduledAt DateTime?
  teacherId   String?  @db.ObjectId
  duration    Int?     // Duration in minutes
  joinLink    String?
  meetingId   String?
  status      String   @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quizzes     Quiz[]
}

model Quiz {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  lessonId     String?       @db.ObjectId
  title        String
  description  String?
  instructions String?
  timeLimit    Int?
  maxAttempts  Int?
  passingScore Float?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  dueDate      DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  events      CalendarEvent[]
  Lesson      Lesson?         @relation(fields: [lessonId], references: [id])
  Interaction Interaction[]
}

model QuizQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  quizId        String   @db.ObjectId
  quiz          Quiz     @relation(fields: [quizId], references: [id])
  question      String
  type          String
  options       Json?
  correctAnswer Json?
  points        Int      @default(1)
  order         Int
  explanation   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuizAttempt {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  quizId      String    @db.ObjectId
  quiz        Quiz      @relation(fields: [quizId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  score       Float?
  maxScore    Float
  percentage  Float?
  isPassed    Boolean   @default(false)
  timeSpent   Int?
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  gradedAt    DateTime?
  gradedBy    String?   @db.ObjectId
  grader      User?     @relation("QuizGrader", fields: [gradedBy], references: [id])
  answers     Json?
  feedback    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([quizId, studentId, startedAt])
}

model Assignment {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  title        String
  description  String?
  instructions String?
  type         String
  maxScore     Float?
  dueDate      DateTime?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  submissions Submission[]
  events      CalendarEvent[]
}

model Submission {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String     @db.ObjectId
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  studentId    String     @db.ObjectId
  student      User       @relation(fields: [studentId], references: [id])
  content      String?
  attachments  Json?
  submittedAt  DateTime   @default(now())
  gradedAt     DateTime?
  grade        Float?
  feedback     String?
}

model Poll {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String       @db.ObjectId
  title        String
  description  String?
  moduleId     String?      @db.ObjectId
  course       Course       @relation(fields: [courseId], references: [id])
  liveStreamId String?      @db.ObjectId
  liveStream   LiveStream?  @relation(fields: [liveStreamId], references: [id])
  createdBy    String       @db.ObjectId
  creator      User         @relation(fields: [createdBy], references: [id])
  question     String
  options      PollOption[]
  isActive     Boolean      @default(true)
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  responses PollResponse[]
}

model PollOption {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  pollId String @db.ObjectId
  poll   Poll   @relation(fields: [pollId], references: [id])
  text   String
  order  Int
  votes  Int    @default(0)
}

model Video {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String    @db.ObjectId
  course       Course    @relation(fields: [courseId], references: [id])
  streamId     String    @unique
  title        String
  description  String?
  type         String    @default("on-demand")
  status       String    @default("pending")
  playbackUrl  String?
  thumbnailUrl String?
  duration     Int?
  size         Int?
  uploadedBy   String    @db.ObjectId
  uploader     User      @relation(fields: [uploadedBy], references: [id])
  scheduledAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  chapters     VideoChapter[]
  transcript   VideoTranscript?
  analytics    VideoAnalytics[]
  notes        VideoNote[]
  bookmarks    VideoBookmark[]
}

model LiveStream {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  streamId    String    @unique
  title       String
  description String?
  status      String    @default("ready")
  playbackUrl String?
  rtmpUrl     String?
  streamKey   String?
  isActive    Boolean   @default(false)
  startedAt   DateTime?
  endedAt     DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  questions StreamQuestion[]
  polls     StreamPoll[]
  Poll      Poll[]
  whiteboards Whiteboard[]
}

model StreamQuestion {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId   String
  stream     LiveStream @relation(fields: [streamId], references: [streamId])
  studentId  String     @db.ObjectId
  student    User       @relation(fields: [studentId], references: [id])
  question   String
  timestamp  Int
  isAnswered Boolean    @default(false)
  answeredBy String?    @db.ObjectId
  answer     String?
  answeredAt DateTime?
  createdAt  DateTime   @default(now())
}

model StreamPoll {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId     String
  stream       LiveStream @relation(fields: [streamId], references: [streamId])
  instructorId String     @db.ObjectId
  instructor   User       @relation(fields: [instructorId], references: [id])
  question     String
  options      String[]
  isActive     Boolean    @default(true)
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  responses PollResponse[]
}

model PollResponse {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  pollId    String     @db.ObjectId
  poll      StreamPoll @relation(fields: [pollId], references: [id])
  studentId String     @db.ObjectId
  student   User       @relation(fields: [studentId], references: [id])
  option    String
  createdAt DateTime   @default(now())
  Poll      Poll       @relation(fields: [pollId], references: [id])

  @@unique([pollId, studentId])
}

model Notification {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @db.ObjectId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String    // "system", "course", "message", "assignment", "quiz", "certificate", "announcement"
  title     String
  message   String
  link      String?
  read      Boolean   @default(false)
  readAt    DateTime?
  metadata  Json?     // Additional data (courseId, messageId, etc.)
  createdAt DateTime  @default(now())

  @@index([userId, read, createdAt])
  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model CourseModule {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  content     Json?
  description String?
  order       Int
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quizzes     Quiz[]
  assignments Assignment[]
  progress    Progress[]
  Interaction Interaction[]
}

model Progress {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  studentId    String        @db.ObjectId
  student      User          @relation(fields: [studentId], references: [id])
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  type         String
  itemId       String        @db.ObjectId
  status       String
  progress     Float         @default(0)
  score        Float?
  timeSpent    Int?
  lastAccessed DateTime      @default(now())
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([studentId, courseId, type, itemId])
}

model Achievement {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  student   User     @relation(fields: [studentId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  badgeName String
  badgeIcon String?
  earnedAt  DateTime @default(now())
  metadata  Json?

  @@unique([studentId, courseId, badgeName])
}

model Certificate {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  description String?
  template    String?
  issuedAt    DateTime  @default(now())
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([studentId, courseId])
}

model CourseRecommendation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String   @db.ObjectId
  course    Course   @relation(fields: [courseId], references: [id])
  score     Float
  reason    String
  algorithm String
  metadata  Json?
  isViewed  Boolean  @default(false)
  isClicked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([userId, score])
}

model UserInteraction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  type      String
  value     Float?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, type])
  @@index([courseId, type])
}

model CalendarEvent {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  type        String
  startTime   DateTime
  endTime     DateTime?
  isAllDay    Boolean   @default(false)
  location    String?
  courseId    String?   @db.ObjectId
  course      Course?   @relation(fields: [courseId], references: [id])
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])

  assignmentId String?     @db.ObjectId
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  quizId       String?     @db.ObjectId
  quiz         Quiz?       @relation(fields: [quizId], references: [id])

  isRecurring    Boolean @default(false)
  recurrenceRule String? // RRULE format (e.g., "FREQ=WEEKLY;BYDAY=MO")
  recurrenceEnd  DateTime?
  timezone       String  @default("UTC")
  maxAttendees   Int?
  waitlistEnabled Boolean @default(false)

  reminderMinutes Int[] @default([15])

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendees EventAttendee[]
  reminders EventReminder[]
  waitlist  WaitlistEntry[]

  @@index([courseId, startTime])
  @@index([createdBy, startTime])
  @@index([isRecurring, recurrenceEnd])
}

model EventAttendee {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String        @db.ObjectId
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String        @db.ObjectId
  user      User          @relation(fields: [userId], references: [id])
  status    String        @default("invited")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([eventId, userId])
}

model EventReminder {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId    String        @db.ObjectId
  event      CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId     String        @db.ObjectId
  user       User          @relation(fields: [userId], references: [id])
  reminderAt DateTime
  type       String        @default("email")
  isSent     Boolean       @default(false)
  createdAt  DateTime      @default(now())

  @@index([reminderAt, isSent])
}

model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?  @db.ObjectId
  metadata  Json?
  createdAt DateTime @default(now())
}


model Webhook {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  url         String
  secret      String
  events      String[] // ["enrollment.created", "course.completed", "payment.completed", etc.]
  isActive    Boolean  @default(true)
  lastTriggered DateTime?
  failureCount Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deliveries WebhookDelivery[]

  @@index([isActive, createdAt])
}

model WebhookDelivery {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  webhookId String   @db.ObjectId
  webhook   Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event     String
  payload   Json
  status    String   // "pending", "success", "failed"
  statusCode Int?
  response  String?
  attempts  Int      @default(0)
  nextRetry DateTime?
  createdAt DateTime @default(now())
  deliveredAt DateTime?

  @@index([webhookId, status, createdAt])
  @@index([status, nextRetry])
}

model ApiKey {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  keyHash     String   @unique
  userId      String?  @db.ObjectId
  user        User?    @relation("ApiKeyUser", fields: [userId], references: [id], onDelete: Cascade)
  permissions String[] // ["read", "write", "admin"]
  rateLimit   Int      @default(1000) // requests per hour
  lastUsed    DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, isActive])
}

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation("ActivityLogUser", fields: [userId], references: [id], onDelete: Cascade)
  action    String   // "course.viewed", "quiz.completed", "enrollment.created", etc.
  entity    String   // "course", "quiz", "enrollment", etc.
  entityId  String?  @db.ObjectId
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entity, entityId, createdAt])
  @@index([action, createdAt])
}

model ContentVersion {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  entityType  String   // "course", "lesson", "quiz", "assignment"
  entityId    String   @db.ObjectId
  version     Int
  content     Json     // Full content snapshot
  createdBy   String   @db.ObjectId
  creator     User     @relation("ContentVersionCreator", fields: [createdBy], references: [id])
  changeNote  String?
  isCurrent   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([entityType, entityId, version])
  @@index([entityType, entityId, isCurrent])
  @@index([createdBy, createdAt])
}

model ContentFlag {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  contentId   String   @db.ObjectId
  contentType String   // "course", "lesson", "quiz", "assignment", "message", "comment"
  reason      String   // "spam", "inappropriate", "copyright", "harassment", "other"
  reportedBy  String   @db.ObjectId
  reporter    User     @relation("ContentFlagReporter", fields: [reportedBy], references: [id])
  description String?
  status      String   @default("pending") // "pending", "under_review", "approved", "rejected", "removed"
  reviewedBy  String?  @db.ObjectId
  reviewer    User?    @relation("ContentFlagReviewer", fields: [reviewedBy], references: [id])
  reviewedAt  DateTime?
  action      String?  // Notes or action taken
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([contentId, contentType, status])
  @@index([status, createdAt])
  @@index([reportedBy, createdAt])
}

model CourseReview {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentId   String   @db.ObjectId
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  rating      Int      // 1-5 stars
  title       String?
  content     String
  isVerified  Boolean  @default(false) // Verified purchase/enrollment
  isPublished Boolean  @default(true)
  helpfulCount Int     @default(0)
  instructorResponse String?
  instructorResponseAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  helpfulVotes ReviewHelpful[]

  @@unique([courseId, studentId])
  @@index([courseId, rating, createdAt])
  @@index([studentId, createdAt])
  @@index([isPublished, createdAt])
}

model ReviewHelpful {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewId  String   @db.ObjectId
  review    CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isHelpful Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([reviewId, isHelpful])
}

model ForumPost {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  authorId    String   @db.ObjectId
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  title       String
  content     String
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  isResolved  Boolean  @default(false)
  bestAnswerId String? @unique @db.ObjectId
  bestAnswer  ForumReply? @relation("PostBestAnswer", fields: [bestAnswerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  upvoteCount Int      @default(0)
  replyCount  Int      @default(0)
  viewCount   Int      @default(0)
  lastReplyAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  replies     ForumReply[] @relation("PostReplies")
  upvotes     ForumUpvote[] @relation("PostUpvotes")

  @@index([courseId, createdAt])
  @@index([courseId, isPinned, createdAt])
  @@index([authorId, createdAt])
  @@index([isResolved, createdAt])
}

model ForumReply {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String   @db.ObjectId
  post      ForumPost @relation("PostReplies", fields: [postId], references: [id], onDelete: Cascade)
  authorId  String   @db.ObjectId
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  parentId  String?  @db.ObjectId
  parent    ForumReply? @relation("ReplyParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   ForumReply[] @relation("ReplyParent")
  upvoteCount Int    @default(0)
  isBestAnswer Boolean @default(false)
  bestAnswerFor ForumPost? @relation("PostBestAnswer")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  upvotes   ForumUpvote[] @relation("ReplyUpvotes")

  @@index([postId, createdAt])
  @@index([authorId, createdAt])
  @@index([parentId, createdAt])
}

model ForumUpvote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  postId    String?  @db.ObjectId
  post      ForumPost? @relation("PostUpvotes", fields: [postId], references: [id], onDelete: Cascade)
  replyId   String?  @db.ObjectId
  reply     ForumReply? @relation("ReplyUpvotes", fields: [replyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@unique([replyId, userId])
  @@index([userId, createdAt])
}

model UserPoints {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  user      User     @relation("UserPointsUser", fields: [userId], references: [id], onDelete: Cascade)
  totalPoints Int    @default(0)
  currentLevel Int   @default(1)
  currentXP   Int    @default(0)
  xpToNextLevel Int  @default(100)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([totalPoints])
  @@index([currentLevel])
}

model UserLevel {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation("UserLevelUser", fields: [userId], references: [id], onDelete: Cascade)
  level     Int
  xpEarned  Int
  achievedAt DateTime @default(now())

  @@index([userId, achievedAt])
  @@index([level, achievedAt])
}

model Badge {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  description String
  icon        String?
  category    String   // "course", "achievement", "social", "learning"
  rarity      String   @default("common") // "common", "rare", "epic", "legendary"
  points      Int      @default(0)
  criteria    Json?    // Conditions to earn badge
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  earnedBy    EarnedBadge[]

  @@index([category, rarity])
}

model EarnedBadge {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String   @db.ObjectId
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt  DateTime @default(now())
  metadata  Json?

  @@unique([userId, badgeId])
  @@index([userId, earnedAt])
  @@index([badgeId, earnedAt])
}

model LeaderboardEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  period    String   // "daily", "weekly", "monthly", "all_time"
  points    Int      @default(0)
  rank      Int
  periodStart DateTime
  periodEnd   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId, period, periodStart])
  @@index([courseId, period, points])
  @@index([period, points, rank])
}

model LoginStreak {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak Int  @default(0)
  longestStreak  Int @default(0)
  lastLoginDate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([currentStreak])
}

model VideoNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId   String   @db.ObjectId
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  timestamp Float    // Time in seconds
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoId, userId, timestamp])
  @@index([userId, createdAt])
}

model VideoBookmark {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId   String   @db.ObjectId
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  timestamp Float    // Time in seconds
  title     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([videoId, userId, timestamp])
  @@index([userId, createdAt])
}

model VideoChapter {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId   String   @db.ObjectId
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  title     String
  startTime Float    // Time in seconds
  endTime   Float?
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoId, order])
}

model VideoTranscript {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId   String   @unique @db.ObjectId
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  language  String   @default("en")
  segments  Json     // Array of {start, end, text}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoId, language])
}

model VideoAnalytics {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId  String   @db.ObjectId
  video    Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  userId   String   @db.ObjectId
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchTime Float   // Total seconds watched
  completionRate Float // Percentage watched
  dropOffPoints Json? // Array of timestamps where users stopped
  playbackSpeed Float @default(1.0)
  lastWatchedAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([videoId, userId])
  @@index([videoId, completionRate])
  @@index([userId, lastWatchedAt])
}

model StudyGroup {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String?  @db.ObjectId
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdBy   String   @db.ObjectId
  creator     User     @relation("GroupCreator", fields: [createdBy], references: [id])
  maxMembers  Int      @default(10)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     GroupMember[]
  projects    GroupProject[]
  workspaces  SharedWorkspace[]

  @@index([courseId, createdAt])
  @@index([createdBy, createdAt])
}

model GroupMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId   String   @db.ObjectId
  group     StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member") // "admin", "member"
  joinedAt  DateTime @default(now())

  @@unique([groupId, userId])
  @@index([userId, joinedAt])
}

model GroupProject {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId     String   @db.ObjectId
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  title       String
  description String?
  dueDate     DateTime?
  status      String   @default("in_progress") // "planning", "in_progress", "completed"
  createdBy   String   @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId, status, dueDate])
}

model SharedWorkspace {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  groupId     String?  @db.ObjectId
  group       StudyGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)
  courseId    String?  @db.ObjectId
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  type        String   @default("document") // "document", "whiteboard", "code"
  content     Json?    // Workspace content
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId, createdAt])
  @@index([courseId, createdAt])
  @@index([userId, createdAt])
}

model WaitlistEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  eventId   String?  @db.ObjectId
  event     CalendarEvent? @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  position  Int
  notifiedAt DateTime?
  enrolledAt DateTime?
  createdAt DateTime @default(now())

  @@unique([courseId, userId])
  @@unique([eventId, userId])
  @@index([courseId, position])
  @@index([eventId, position])
  @@index([userId, createdAt])
}

model Interaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  courseId  String?  @db.ObjectId
  moduleId  String?  @db.ObjectId
  quizId    String?  @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  user   User          @relation(fields: [userId], references: [id])
  course Course?       @relation(fields: [courseId], references: [id])
  module CourseModule? @relation(fields: [moduleId], references: [id])
  quiz   Quiz?         @relation(fields: [quizId], references: [id])
}

model Conversation {
  id          String                  @id @default(auto()) @map("_id") @db.ObjectId
  type        String                  @default("direct") // "direct" or "group"
  name        String?                 // For group conversations
  description String?
  createdBy   String                  @db.ObjectId
  creator     User                    @relation(fields: [createdBy], references: [id])
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@index([createdBy])
  @@index([type])
}

model ConversationParticipant {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id])
  role           String       @default("member") // "admin", "member"
  joinedAt       DateTime   @default(now())
  lastReadAt     DateTime?
  isMuted        Boolean    @default(false)
  leftAt         DateTime?

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String       @db.ObjectId
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String       @db.ObjectId
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
  receiverId     String?      @db.ObjectId
  receiver       User?        @relation("MessageReceiver", fields: [receiverId], references: [id])
  content        String
  type           String       @default("text") // "text", "image", "file", "system"
  attachments    Json?        // Array of file attachments
  isRead         Boolean      @default(false)
  readAt         DateTime?
  isEdited       Boolean      @default(false)
  editedAt       DateTime?
  isDeleted      Boolean      @default(false)
  deletedAt      DateTime?
  replyToId      String?      @db.ObjectId
  replyTo        Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[]    @relation("MessageReplies")
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  reactions MessageReaction[]
  reads     MessageRead[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([content]) // For search
}

model MessageReaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // e.g., "üëç", "‚ù§Ô∏è", "üòÇ"
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model MessageRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model Announcement {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  message     String
  type        String    @default("global") // "global", "course", "user"
  scope       String    @default("global") // "global", "course", "user"
  courseId    String?   @db.ObjectId
  course      Course?   @relation(fields: [courseId], references: [id])
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  targetUserId String?  @db.ObjectId
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([scope, courseId])
  @@index([createdBy])
  @@index([isActive, expiresAt])
}

model TeacherAvailability {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  teacherId   String    @db.ObjectId
  teacher     User      @relation(fields: [teacherId], references: [id])
  startTime   DateTime
  endTime     DateTime
  isRecurring Boolean   @default(false)
  recurrenceRule String?
  subject     String?
  duration    Int?      // Duration in minutes
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  slots       LessonSlot[]
  @@index([teacherId, startTime])
}

model LessonSlot {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  availabilityId String? @db.ObjectId
  availability TeacherAvailability? @relation(fields: [availabilityId], references: [id])
  teacherId    String    @db.ObjectId
  teacher      User      @relation("LessonSlotTeacher", fields: [teacherId], references: [id])
  startTime    DateTime
  endTime      DateTime
  subject      String?
  duration     Int       // Duration in minutes
  isBooked     Boolean   @default(false)
  isAvailable  Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  booking     Booking?
  @@unique([availabilityId, startTime])
  @@index([teacherId, startTime])
  @@index([isBooked, isAvailable])
}

model Booking {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  slotId      String    @unique @db.ObjectId
  slot        LessonSlot @relation(fields: [slotId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation("BookingStudent", fields: [studentId], references: [id])
  teacherId   String    @db.ObjectId
  teacher     User      @relation("BookingTeacher", fields: [teacherId], references: [id])
  status      String    @default("confirmed") // "confirmed", "cancelled", "completed"
  subject     String?
  notes       String?
  joinLink    String?
  meetingId   String?
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attendance  Attendance?
  @@index([studentId, createdAt])
  @@index([teacherId, createdAt])
  @@index([status])
}

model QuickLesson {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  teacherId   String    @db.ObjectId
  teacher     User      @relation("QuickLessonTeacher", fields: [teacherId], references: [id])
  scheduledAt DateTime
  subject     String?
  duration    Int?      // Duration in minutes
  joinLink    String?
  meetingId   String?
  status      String    @default("scheduled") // "scheduled", "in_progress", "completed", "cancelled"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  attendance  Attendance[]
  resources   LessonResource[]
  @@index([teacherId, scheduledAt])
  @@index([status])
}

model Attendance {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonId    String?   @db.ObjectId
  lesson      QuickLesson? @relation(fields: [lessonId], references: [id])
  bookingId   String?   @unique @db.ObjectId
  booking     Booking?  @relation(fields: [bookingId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  status      String    // "present", "absent", "late"
  joinedAt    DateTime?
  leftAt      DateTime?
  duration    Int?      // Duration in seconds
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([lessonId, studentId])
  @@index([studentId])
  @@index([status])
}

model LessonResource {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  lessonId    String    @db.ObjectId
  lesson      QuickLesson @relation(fields: [lessonId], references: [id])
  title       String
  type        String    // "file", "link", "document"
  url         String?
  fileUrl     String?
  filename    String?
  size        Int?
  mimeType    String?
  sharedBy    String    @db.ObjectId
  sharer      User      @relation("LessonResourceSharer", fields: [sharedBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([lessonId, createdAt])
}

model VideoConference {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  conferenceId String   @unique
  title       String
  hostId      String    @db.ObjectId
  host        User      @relation("VideoConferenceHost", fields: [hostId], references: [id])
  joinLink    String
  status      String    @default("scheduled") // "scheduled", "active", "ended"
  startedAt   DateTime?
  endedAt     DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  rooms       BreakoutRoom[]
  @@index([hostId, createdAt])
}

model BreakoutRoom {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  conferenceDbId String          @db.ObjectId
  conference    VideoConference @relation(fields: [conferenceDbId], references: [id])
  name          String
  joinLink      String?
  status        String          @default("open") // "open", "closed"
  participants  String[]        // Array of user IDs
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([conferenceDbId, status])
}

model Whiteboard {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String?            @db.ObjectId
  course      Course?            @relation(fields: [courseId], references: [id])
  liveStreamId String?           @db.ObjectId
  liveStream  LiveStream?        @relation(fields: [liveStreamId], references: [id])
  title       String
  description String?
  createdBy   String             @db.ObjectId
  creator     User               @relation("WhiteboardCreator", fields: [createdBy], references: [id])
  isActive    Boolean            @default(true)
  isPublic    Boolean            @default(false)
  backgroundColor String          @default("#FFFFFF")
  width       Int                @default(1920)
  height      Int                @default(1080)
  actions     WhiteboardAction[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([courseId, createdAt])
  @@index([liveStreamId, createdAt])
}

model WhiteboardAction {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  whiteboardId String    @db.ObjectId
  whiteboard  Whiteboard @relation(fields: [whiteboardId], references: [id], onDelete: Cascade)
  userId      String     @db.ObjectId
  user        User       @relation("WhiteboardActionUser", fields: [userId], references: [id])
  actionType  String     // "draw", "erase", "clear", "undo", "redo", "add_text", "add_shape"
  data        Json       // Contains action-specific data (coordinates, color, tool, etc.)
  timestamp   DateTime   @default(now())
  createdAt   DateTime   @default(now())

  @@index([whiteboardId, timestamp])
  @@index([userId, timestamp])
}

model UserSettings {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  userId                String    @unique @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification preferences
  emailNotifications    Boolean   @default(true)
  pushNotifications     Boolean   @default(true)
  courseUpdates         Boolean   @default(true)
  deadlineReminders     Boolean   @default(true)
  newMessages           Boolean   @default(true)
  marketingEmails       Boolean   @default(false)
  weeklyDigest          Boolean   @default(true)
  certificateIssued     Boolean   @default(true)
  assignmentGraded      Boolean   @default(true)
  quizResults           Boolean   @default(true)
  
  // Privacy settings
  profileVisibility     String    @default("public") // "public", "private", "friends"
  showEmail             Boolean   @default(false)
  showProgress          Boolean   @default(true)
  showAchievements      Boolean   @default(true)
  showCertificates      Boolean   @default(true)
  
  // Learning preferences
  language              String    @default("en")
  timezone              String    @default("UTC")
  dateFormat            String    @default("MM/DD/YYYY")
  videoPlaybackSpeed    Float     @default(1.0)
  autoPlayVideos        Boolean   @default(false)
  showSubtitles         Boolean   @default(false)
  preferredSubtitleLang String    @default("en")
  
  // Account settings
  twoFactorEnabled      Boolean   @default(false)
  twoFactorSecret       String?
  connectedAccounts     Json?     // OAuth connected accounts
  lastPasswordChange    DateTime?
  accountDeletionRequested Boolean @default(false)
  accountDeletionDate   DateTime?
  
  // UI preferences (for frontend)
  theme                 String    @default("light") // "light", "dark", "auto"
  compactMode           Boolean   @default(false)
  sidebarCollapsed      Boolean   @default(false)
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}
