generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  username            String    @unique
  email               String    @unique
  password            String
  role                String
  failedLoginAttempts Int       @default(0)
  lockoutUntil        DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  courses            Course[]               @relation("InstructorCourses")
  enrollments        Enrollment[]
  submissions        Submission[]
  payments           Payment[]
  securityLogs       SecurityLog[]
  materials          Material[]
  videos             Video[]
  liveStreams        LiveStream[]
  streamQuestions    StreamQuestion[]
  streamPolls        StreamPoll[]
  pollResponses      PollResponse[]
  courseModules      CourseModule[]
  quizAttempts       QuizAttempt[]
  quizGraded         QuizAttempt[]          @relation("QuizGrader")
  createdQuizzes     Quiz[]
  createdAssignments Assignment[]
  progress           Progress[]
  achievements       Achievement[]
  certificates       Certificate[]
  recommendations    CourseRecommendation[]
  interactions       UserInteraction[]
  createdEvents      CalendarEvent[]
  eventAttendees     EventAttendee[]
  eventReminders     EventReminder[]
  Poll               Poll[]
  Notification       Notification[]
  AuditLog           AuditLog[]
  Interaction        Interaction[]
}

model SecurityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())
}

model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  price       Float
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   @db.ObjectId

  instructorId String @db.ObjectId
  instructor   User   @relation("InstructorCourses", fields: [instructorId], references: [id])

  enrollments     Enrollment[]
  lessons         Lesson[]
  quizzes         Quiz[]
  polls           Poll[]
  assignments     Assignment[]
  payments        Payment[]
  materials       Material[]
  videos          Video[]
  liveStreams     LiveStream[]
  modules         CourseModule[]
  progress        Progress[]
  achievements    Achievement[]
  certificates    Certificate[]
  recommendations CourseRecommendation[]
  interactions    UserInteraction[]
  events          CalendarEvent[]
  Interaction     Interaction[]
}

model Enrollment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])

  paymentId String?  @unique @db.ObjectId
  payment   Payment? @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
}

model Payment {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  studentId String @db.ObjectId
  student   User   @relation(fields: [studentId], references: [id])
  courseId  String @db.ObjectId
  course    Course @relation(fields: [courseId], references: [id])

  enrollment Enrollment?

  amount        Float
  currency      String   @default("USD")
  status        String
  provider      String
  transactionId String?
  createdAt     DateTime @default(now())
}

model Material {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId   String   @db.ObjectId
  course     Course   @relation(fields: [courseId], references: [id])
  type       String
  key        String
  filename   String
  size       Int
  mimeType   String
  url        String
  uploadedBy String   @db.ObjectId
  uploader   User     @relation(fields: [uploadedBy], references: [id])
  meta       Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Lesson {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId  String   @db.ObjectId
  course    Course   @relation(fields: [courseId], references: [id])
  title     String
  content   Json?
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quizzes   Quiz[]
}

model Quiz {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  lessonId     String?       @db.ObjectId
  title        String
  description  String?
  instructions String?
  timeLimit    Int?
  maxAttempts  Int?
  passingScore Float?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  dueDate      DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  events      CalendarEvent[]
  Lesson      Lesson?         @relation(fields: [lessonId], references: [id])
  Interaction Interaction[]
}

model QuizQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  quizId        String   @db.ObjectId
  quiz          Quiz     @relation(fields: [quizId], references: [id])
  question      String
  type          String
  options       Json?
  correctAnswer Json?
  points        Int      @default(1)
  order         Int
  explanation   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuizAttempt {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  quizId      String    @db.ObjectId
  quiz        Quiz      @relation(fields: [quizId], references: [id])
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  score       Float?
  maxScore    Float
  percentage  Float?
  isPassed    Boolean   @default(false)
  timeSpent   Int?
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  gradedAt    DateTime?
  gradedBy    String?   @db.ObjectId
  grader      User?     @relation("QuizGrader", fields: [gradedBy], references: [id])
  answers     Json?
  feedback    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([quizId, studentId, startedAt])
}

model Assignment {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  title        String
  description  String?
  instructions String?
  type         String
  maxScore     Float?
  dueDate      DateTime?
  isPublished  Boolean       @default(false)
  publishedAt  DateTime?
  createdBy    String        @db.ObjectId
  creator      User          @relation(fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  submissions Submission[]
  events      CalendarEvent[]
}

model Submission {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String     @db.ObjectId
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  studentId    String     @db.ObjectId
  student      User       @relation(fields: [studentId], references: [id])
  content      String?
  attachments  Json?
  submittedAt  DateTime   @default(now())
  gradedAt     DateTime?
  grade        Float?
  feedback     String?
}

model Poll {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String       @db.ObjectId
  title        String
  description  String?
  moduleId     String?      @db.ObjectId
  course       Course       @relation(fields: [courseId], references: [id])
  liveStreamId String?      @db.ObjectId
  liveStream   LiveStream?  @relation(fields: [liveStreamId], references: [id])
  createdBy    String       @db.ObjectId
  creator      User         @relation(fields: [createdBy], references: [id])
  question     String
  options      PollOption[]
  isActive     Boolean      @default(true)
  expiresAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  responses PollResponse[]
}

model PollOption {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  pollId String @db.ObjectId
  poll   Poll   @relation(fields: [pollId], references: [id])
  text   String
  order  Int
  votes  Int    @default(0)
}

model Video {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String    @db.ObjectId
  course       Course    @relation(fields: [courseId], references: [id])
  streamId     String    @unique
  title        String
  description  String?
  type         String    @default("on-demand")
  status       String    @default("pending")
  playbackUrl  String?
  thumbnailUrl String?
  duration     Int?
  size         Int?
  uploadedBy   String    @db.ObjectId
  uploader     User      @relation(fields: [uploadedBy], references: [id])
  scheduledAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model LiveStream {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  streamId    String    @unique
  title       String
  description String?
  status      String    @default("ready")
  playbackUrl String?
  rtmpUrl     String?
  streamKey   String?
  isActive    Boolean   @default(false)
  startedAt   DateTime?
  endedAt     DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  questions StreamQuestion[]
  polls     StreamPoll[]
  Poll      Poll[]
}

model StreamQuestion {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId   String
  stream     LiveStream @relation(fields: [streamId], references: [streamId])
  studentId  String     @db.ObjectId
  student    User       @relation(fields: [studentId], references: [id])
  question   String
  timestamp  Int
  isAnswered Boolean    @default(false)
  answeredBy String?    @db.ObjectId
  answer     String?
  answeredAt DateTime?
  createdAt  DateTime   @default(now())
}

model StreamPoll {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  streamId     String
  stream       LiveStream @relation(fields: [streamId], references: [streamId])
  instructorId String     @db.ObjectId
  instructor   User       @relation(fields: [instructorId], references: [id])
  question     String
  options      String[]
  isActive     Boolean    @default(true)
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  responses PollResponse[]
}

model PollResponse {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  pollId    String     @db.ObjectId
  poll      StreamPoll @relation(fields: [pollId], references: [id])
  studentId String     @db.ObjectId
  student   User       @relation(fields: [studentId], references: [id])
  option    String
  createdAt DateTime   @default(now())
  Poll      Poll       @relation(fields: [pollId], references: [id])

  @@unique([pollId, studentId])
}

model Notification {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  toUserId  String    @db.ObjectId
  toUser    User      @relation(fields: [toUserId], references: [id])
  title     String
  message   String
  type      String
  metadata  Json?
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?
}

model CourseModule {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  content     Json?
  description String?
  order       Int
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quizzes     Quiz[]
  assignments Assignment[]
  progress    Progress[]
  Interaction Interaction[]
}

model Progress {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  studentId    String        @db.ObjectId
  student      User          @relation(fields: [studentId], references: [id])
  courseId     String        @db.ObjectId
  course       Course        @relation(fields: [courseId], references: [id])
  moduleId     String?       @db.ObjectId
  module       CourseModule? @relation(fields: [moduleId], references: [id])
  type         String
  itemId       String        @db.ObjectId
  status       String
  progress     Float         @default(0)
  score        Float?
  timeSpent    Int?
  lastAccessed DateTime      @default(now())
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([studentId, courseId, type, itemId])
}

model Achievement {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId String   @db.ObjectId
  student   User     @relation(fields: [studentId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  badgeName String
  badgeIcon String?
  earnedAt  DateTime @default(now())
  metadata  Json?

  @@unique([studentId, courseId, badgeName])
}

model Certificate {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  studentId   String    @db.ObjectId
  student     User      @relation(fields: [studentId], references: [id])
  courseId    String    @db.ObjectId
  course      Course    @relation(fields: [courseId], references: [id])
  title       String
  description String?
  template    String?
  issuedAt    DateTime  @default(now())
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([studentId, courseId])
}

model CourseRecommendation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String   @db.ObjectId
  course    Course   @relation(fields: [courseId], references: [id])
  score     Float
  reason    String
  algorithm String
  metadata  Json?
  isViewed  Boolean  @default(false)
  isClicked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([userId, score])
}

model UserInteraction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  courseId  String?  @db.ObjectId
  course    Course?  @relation(fields: [courseId], references: [id])
  type      String
  value     Float?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, type])
  @@index([courseId, type])
}

model CalendarEvent {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  type        String
  startTime   DateTime
  endTime     DateTime?
  isAllDay    Boolean   @default(false)
  location    String?
  courseId    String?   @db.ObjectId
  course      Course?   @relation(fields: [courseId], references: [id])
  createdBy   String    @db.ObjectId
  creator     User      @relation(fields: [createdBy], references: [id])

  assignmentId String?     @db.ObjectId
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  quizId       String?     @db.ObjectId
  quiz         Quiz?       @relation(fields: [quizId], references: [id])

  isRecurring    Boolean @default(false)
  recurrenceRule String?

  reminderMinutes Int[] @default([15])

  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendees EventAttendee[]
  reminders EventReminder[]

  @@index([courseId, startTime])
  @@index([createdBy, startTime])
}

model EventAttendee {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String        @db.ObjectId
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String        @db.ObjectId
  user      User          @relation(fields: [userId], references: [id])
  status    String        @default("invited")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([eventId, userId])
}

model EventReminder {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  eventId    String        @db.ObjectId
  event      CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId     String        @db.ObjectId
  user       User          @relation(fields: [userId], references: [id])
  reminderAt DateTime
  type       String        @default("email")
  isSent     Boolean       @default(false)
  createdAt  DateTime      @default(now())

  @@index([reminderAt, isSent])
}

model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?  @db.ObjectId
  metadata  Json?
  createdAt DateTime @default(now())
}

model Interaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  courseId  String?  @db.ObjectId
  moduleId  String?  @db.ObjectId
  quizId    String?  @db.ObjectId
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  user   User          @relation(fields: [userId], references: [id])
  course Course?       @relation(fields: [courseId], references: [id])
  module CourseModule? @relation(fields: [moduleId], references: [id])
  quiz   Quiz?         @relation(fields: [quizId], references: [id])
}
